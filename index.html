<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Bubble Catcher</title>
    <style>
      html,
      body {
        text-align: center;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Prevent scrolling */
        height: 100%;
        background: #222;
      }

      canvas {
        display: block;
        margin: 0 auto;
        background: #000;
        touch-action: none;
      }

      #restartBtn,
      #downloadBtn {
        font-size: 18px;
        font-weight: bold;
        padding: 10px 20px;
        display: none;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        background-color: #aee800;
        color: #000;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 20;
      }

      #restartBtn {
        top: 80%;
      }

      #downloadBtn {
        top: 90%;
      }

      #title {
        position: absolute;
        top: 10px;
        left: 10px;
        font-family: Arial, sans-serif;
        font-size: 20px;
        color: #aee800;
        z-index: 10;
        font-weight: bold;
      }

      #gameOverScreen {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #b41412;
        color: #aee800;
        text-align: center;
        font-family: Arial, sans-serif;
        z-index: 15;
        padding-top: 5%;
      }

      #gameOverScreen h1,
      #gameOverScreen p {
        margin: 20px 0;
        font-weight: bold;
      }

      #gameOverImage {
        max-width: 60%;
        height: auto;
        margin: 10px auto;
      }
    </style>
  </head>
  <body>
    <div id="title">Bubble Catcher</div>
    <canvas id="gameCanvas"></canvas>
    <div id="gameOverScreen">
      <h1>GAME OVER</h1>
      <p id="finalScore">Score: 0</p>
      <img id="gameOverImage" crossorigin="anonymous" src="https://subaquatic-legacy.github.io/bubblezzzz/images/Game_Lifes_Left_yellow.png" alt="Game Over Image" />
      <p>Expansion pack coming soon!</p>
    </div>
    <button id="restartBtn" onclick="restartGame()">Restart</button>
    <button id="downloadBtn" onclick="downloadScreenshot()">Download & Share</button>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const restartBtn = document.getElementById("restartBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const titleDiv = document.getElementById("title");
      const gameOverScreen = document.getElementById("gameOverScreen");
      const finalScoreText = document.getElementById("finalScore");

      const backgroundImage = new Image();
      backgroundImage.src = "https://subaquatic-legacy.github.io/bubblezzzz/images/Game_BG_1.png";
      backgroundImage.crossOrigin = "anonymous";

      const player = {
        x: 160,
        y: 550,
        width: 100,
        height: 100,
        speed: 7,
        image: new Image(),
      };
      player.image.src = "https://subaquatic-legacy.github.io/bubblezzzz/images/Game_Hero_yellow.png";
      player.image.crossOrigin = "anonymous";

      const whaleImg = new Image();
      whaleImg.crossOrigin = "anonymous";
      whaleImg.src = "https://subaquatic-legacy.github.io/bubblezzzz/images/Game_Lifes_Left_yellow.png";

      const bubbleImage = new Image();
      bubbleImage.src = "https://subaquatic-legacy.github.io/bubblezzzz/images/Game_Bubble.png";
      bubbleImage.crossOrigin = "anonymous";

      const redBubbleImage = new Image();
      redBubbleImage.src = "https://subaquatic-legacy.github.io/bubblezzzz/images/Game_Bubble_cyan.png";
      redBubbleImage.crossOrigin = "anonymous";

      let bubbles = [];
      let score = 0;
      let lives = 3;
      let gameOver = false;
      let bubbleInterval = 2000;
      let lastBubbleTime = 0;
      let lastDifficultyIncrease = Date.now();

      function resizeCanvas() {
        const baseWidth = 360
        const baseHeight = 640
        canvas.width = baseWidth
        canvas.height = baseHeight

        const screenRatio = window.innerWidth / window.innerHeight
        const gameRatio = baseWidth / baseHeight

        if (screenRatio > gameRatio) {
          // Screen is wider than game: limit by height
          canvas.style.height = window.innerHeight + "px"
          canvas.style.width = window.innerHeight * gameRatio + "px"
        } else {
          // Screen is taller than game: limit by width
          canvas.style.width = window.innerWidth + "px"
          canvas.style.height = window.innerWidth / gameRatio + "px"
        }
      }

      function createBubble() {
        const margin = 20;
        const x = margin + Math.random() * (canvas.width - 2 * margin);
        const isRed = Math.random() < 0.15;
        bubbles.push({
          x: x,
          y: 0,
          radius: 15 + Math.random() * 10,
          speed: isRed ? 1 : 1 + Math.random() * 1.5,
          opacity: 0.7 + Math.random() * 0.3,
          red: isRed,
        });
      }

      function update() {
        if (gameOver) return;

        let now = Date.now();
        if (now - lastBubbleTime > bubbleInterval) {
          createBubble();
          lastBubbleTime = now;
        }

        if (now - lastDifficultyIncrease > 10000 && bubbleInterval > 600) {
          bubbleInterval -= 200;
          lastDifficultyIncrease = now;
        }

        bubbles.forEach((bubble, index) => {
          bubble.y += bubble.speed;
          if (bubble.y > canvas.height) {
            bubbles.splice(index, 1);
            lives--;
            if (lives <= 0) {
              triggerGameOver();
            }
          }
        });

        bubbles = bubbles.filter((bubble) => {
          const hit =
            bubble.x > player.x &&
            bubble.x < player.x + player.width &&
            bubble.y + bubble.radius > player.y &&
            bubble.y < player.y + player.height;
          if (hit) score += bubble.red ? 10 : 1;
          return !hit;
        });
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (!gameOver) {
          ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
          ctx.drawImage(player.image, player.x, player.y, player.width, player.height);

          bubbles.forEach((bubble) => {
            const size = bubble.radius * 2;
            ctx.save();
            ctx.globalAlpha = bubble.opacity;
            const img = bubble.red ? redBubbleImage : bubbleImage;
            ctx.drawImage(img, bubble.x - bubble.radius, bubble.y - bubble.radius, size, size);
            ctx.restore();
          });

          ctx.font = "bold 20px Arial";
          ctx.fillStyle = "#aee800";
          ctx.fillText("Score: " + score, canvas.width - 120, 30);

          for (let i = 0; i < lives; i++) {
            ctx.drawImage(whaleImg, 10 + i * 40, 40, 35, 35);
          }
        }
      }

      function triggerGameOver() {
        gameOver = true;
        bubbles = [];
        titleDiv.style.display = "none";
        gameOverScreen.style.display = "block";
        finalScoreText.textContent = "Score: " + score;
        restartBtn.style.display = "inline-block";
        downloadBtn.style.display = "inline-block";
      }

      function restartGame() {
        bubbles = [];
        score = 0;
        lives = 3;
        gameOver = false;
        titleDiv.style.display = "block";
        gameOverScreen.style.display = "none";
        restartBtn.style.display = "none";
        downloadBtn.style.display = "none";
        bubbleInterval = 2000;
        lastBubbleTime = Date.now();
        lastDifficultyIncrease = Date.now();
      }

      function downloadScreenshot() {
        restartBtn.style.display = "none";
        downloadBtn.style.display = "none";

        html2canvas(document.getElementById("gameOverScreen"),{useCORS: true}).then((canvasShot) => {
          const link = document.createElement("a");
          link.download = "bubblecatcher_score.png";
          link.href = canvasShot.toDataURL();
          link.click();

          restartBtn.style.display = "inline-block";
          downloadBtn.style.display = "inline-block";
        });
      }
      
      

      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();
      function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
      let keys = {};
      document.addEventListener("keydown", (e) => (keys[e.key] = true));
      document.addEventListener("keyup", (e) => (keys[e.key] = false));

      let isTouching = false;
      canvas.addEventListener("touchstart", function (e) {
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const touchX = touch.clientX - rect.left;
        if (touchX >= player.x && touchX <= player.x + player.width) {
          isTouching = true;
        }
      });
      canvas.addEventListener("touchmove", function (e) {
        if (isTouching) {
          const touch = e.touches[0];
          const rect = canvas.getBoundingClientRect();
          const touchX = touch.clientX - rect.left;
          player.x = touchX - player.width / 2;
          if (player.x < 0) player.x = 0;
          if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
        }
        e.preventDefault();
      }, { passive: false });
      canvas.addEventListener("touchend", function () { isTouching = false; });

      function movePlayer() {
        if (!gameOver) {
          if (keys["ArrowLeft"] && player.x > 0) player.x -= player.speed;
          if (keys["ArrowRight"] && player.x + player.width < canvas.width) player.x += player.speed;
        }
        requestAnimationFrame(movePlayer);
      }

      gameLoop();
      movePlayer();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  </body>
</html>
